<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»çµ±è‡ªå‹•åŒ–æ¸¬è©¦</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        h1 {
            color: #0ABAB5;
            margin-bottom: 30px;
        }

        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .test-item {
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #ddd;
            background: #f9f9f9;
        }

        .test-item.pass {
            border-left-color: #4caf50;
            background: #f1f8f4;
        }

        .test-item.fail {
            border-left-color: #f44336;
            background: #fef1f0;
        }

        .test-item.running {
            border-left-color: #ff9800;
            background: #fff8f0;
        }

        button {
            background: #0ABAB5;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }

        button:hover {
            background: #099a95;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: bold;
            margin-left: 10px;
        }

        .status.pass {
            background: #4caf50;
            color: white;
        }

        .status.fail {
            background: #f44336;
            color: white;
        }

        .status.running {
            background: #ff9800;
            color: white;
        }

        .status.pending {
            background: #ddd;
            color: #666;
        }

        pre {
            background: #272822;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 13px;
        }

        .summary {
            font-size: 18px;
            font-weight: bold;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin: 20px 0;
        }

        .summary.success {
            background: #4caf50;
            color: white;
        }

        .summary.failure {
            background: #f44336;
            color: white;
        }
    </style>
</head>

<body>
    <h1>ğŸ§ª MiTAC HR è¨“ç·´ç³»çµ± - è‡ªå‹•åŒ–æ¸¬è©¦</h1>

    <div class="test-section">
        <h2>æ¸¬è©¦æ§åˆ¶</h2>
        <button id="btnRunTests">åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦</button>
        <button id="btnClearStorage">æ¸…é™¤ Storage</button>
        <button id="btnViewStorage">æŸ¥çœ‹ Storage</button>
    </div>

    <div class="test-section">
        <h2>æ¸¬è©¦çµæœ</h2>
        <div id="testResults"></div>
    </div>

    <div class="test-section" id="storageView" style="display:none;">
        <h2>Storage å…§å®¹</h2>
        <h3>Session Storage</h3>
        <pre id="sessionStorageContent"></pre>
        <h3>Local Storage</h3>
        <pre id="localStorageContent"></pre>
    </div>

    <script type="module">
        const results = [];
        let testCount = 0;
        let passCount = 0;
        let failCount = 0;

        function updateTestUI(name, status, message = '') {
            const container = document.getElementById('testResults');
            const testId = `test-${testCount++}`;

            const testDiv = document.createElement('div');
            testDiv.className = `test-item ${status}`;
            testDiv.id = testId;
            testDiv.innerHTML = `
                <strong>${name}</strong>
                <span class="status ${status}">${status === 'pass' ? 'âœ… é€šé' : status === 'fail' ? 'âŒ å¤±æ•—' : status === 'running' ? 'â³ åŸ·è¡Œä¸­' : 'â¸ å¾…åŸ·è¡Œ'}</span>
                ${message ? `<div style="margin-top: 10px; color: #666;">${message}</div>` : ''}
            `;
            container.appendChild(testDiv);

            if (status === 'pass') passCount++;
            if (status === 'fail') failCount++;

            return testId;
        }

        function updateTest(testId, status, message = '') {
            const testDiv = document.getElementById(testId);
            if (testDiv) {
                testDiv.className = `test-item ${status}`;
                const statusSpan = testDiv.querySelector('.status');
                statusSpan.className = `status ${status}`;
                statusSpan.textContent = status === 'pass' ? 'âœ… é€šé' : status === 'fail' ? 'âŒ å¤±æ•—' : 'â³ åŸ·è¡Œä¸­';

                if (message) {
                    let msgDiv = testDiv.querySelector('.test-message');
                    if (!msgDiv) {
                        msgDiv = document.createElement('div');
                        msgDiv.className = 'test-message';
                        msgDiv.style.marginTop = '10px';
                        msgDiv.style.color = '#666';
                        testDiv.appendChild(msgDiv);
                    }
                    msgDiv.innerHTML = message;
                }
            }
        }

        async function runTests() {
            testCount = 0;
            passCount = 0;
            failCount = 0;
            document.getElementById('testResults').innerHTML = '';

            // Test 1: æª¢æŸ¥ Firebase é…ç½®
            const test1 = updateTestUI('Test 1: Firebase é…ç½®æª¢æŸ¥', 'running');
            try {
                const response = await fetch('/firebase-config.js');
                const text = await response.text();
                if (text.includes('hr-online-training.firebaseapp.com') && text.includes('getAuth')) {
                    updateTest(test1, 'pass', 'Firebase é…ç½®æ­£ç¢ºè¼‰å…¥');
                } else {
                    updateTest(test1, 'fail', 'Firebase é…ç½®ç•°å¸¸');
                }
            } catch (e) {
                updateTest(test1, 'fail', `éŒ¯èª¤: ${e.message}`);
            }

            // Test 2: æª¢æŸ¥ app.js è¼‰å…¥
            const test2 = updateTestUI('Test 2: app.js ä¸»ç¨‹å¼æª¢æŸ¥', 'running');
            try {
                const response = await fetch('/app.js');
                const text = await response.text();
                if (text.includes('enableV5') && text.includes('initializeUser') && text.includes('renderArchivesView')) {
                    updateTest(test2, 'pass', 'app.js åŒ…å«æ‰€æœ‰å¿…è¦å‡½æ•¸');
                } else {
                    updateTest(test2, 'fail', 'app.js ç¼ºå°‘é—œéµå‡½æ•¸');
                }
            } catch (e) {
                updateTest(test2, 'fail', `éŒ¯èª¤: ${e.message}`);
            }

            // Test 3: æª¢æŸ¥ enableV5 è¨­å®š
            const test3 = updateTestUI('Test 3: v5 æ¨¡å¼å•Ÿç”¨æª¢æŸ¥', 'running');
            try {
                const response = await fetch('/app.js');
                const text = await response.text();
                const match = text.match(/const\s+enableV5\s*=\s*(true|false)/);
                if (match && match[1] === 'true') {
                    updateTest(test3, 'pass', 'v5 æ¨¡å¼å·²å•Ÿç”¨ (enableV5 = true)');
                } else {
                    updateTest(test3, 'fail', `v5 æ¨¡å¼æœªå•Ÿç”¨ (enableV5 = ${match ? match[1] : 'unknown'})`);
                }
            } catch (e) {
                updateTest(test3, 'fail', `éŒ¯èª¤: ${e.message}`);
            }

            // Test 4: æª¢æŸ¥é—œéµä¿®å¾©é»
            const test4 = updateTestUI('Test 4: Admin Session ä¿®å¾©æª¢æŸ¥', 'running');
            try {
                const response = await fetch('/app.js');
                const text = await response.text();

                const fixes = {
                    'L198 è¨»è§£': text.includes('// state.adminLoggedIn = false;'),
                    'L203 æ¢ä»¶åˆ¤æ–·': text.includes('if (!state.adminLoggedIn)'),
                    'L807 åˆå§‹åŒ–é †åº': text.includes('await initializeUser();') && text.indexOf('await initializeUser();') < text.indexOf('AuthManager.init();'),
                    'L841 ç™»å…¥ä»‹é¢æ¢ä»¶': text.includes('!state.adminLoggedIn && route !== \'#admin\'')
                };

                const allFixed = Object.values(fixes).every(v => v);
                if (allFixed) {
                    updateTest(test4, 'pass', 'æ‰€æœ‰é—œéµä¿®å¾©é»éƒ½æ­£ç¢ºå¯¦ä½œ:<br>' +
                        Object.entries(fixes).map(([k, v]) => `â€¢ ${k}: ${v ? 'âœ…' : 'âŒ'}`).join('<br>'));
                } else {
                    updateTest(test4, 'fail', 'éƒ¨åˆ†ä¿®å¾©é»ç¼ºå¤±:<br>' +
                        Object.entries(fixes).map(([k, v]) => `â€¢ ${k}: ${v ? 'âœ…' : 'âŒ'}`).join('<br>'));
                }
            } catch (e) {
                updateTest(test4, 'fail', `éŒ¯èª¤: ${e.message}`);
            }

            // Test 5: æª¢æŸ¥ renderArchivesView
            const test5 = updateTestUI('Test 5: æ­·å²å°å­˜å‡½æ•¸æª¢æŸ¥', 'running');
            try {
                const response = await fetch('/app.js');
                const text = await response.text();

                if (text.includes('async function renderArchivesView(container)') &&
                    text.includes('query(collection(db, "users"), where("status", "==", "archived"))')) {
                    updateTest(test5, 'pass', 'renderArchivesView ä½¿ç”¨ v10 SDK æ­£ç¢ºå¯¦ä½œ');
                } else {
                    updateTest(test5, 'fail', 'renderArchivesView å‡½æ•¸ç•°å¸¸');
                }
            } catch (e) {
                updateTest(test5, 'fail', `éŒ¯èª¤: ${e.message}`);
            }

            // Test 6: Index.html æª¢æŸ¥
            const test6 = updateTestUI('Test 6: index.html æª¢æŸ¥', 'running');
            try {
                const response = await fetch('/index.html');
                const text = await response.text();
                if (text.includes('type="module"') && text.includes('app.js')) {
                    updateTest(test6, 'pass', 'index.html æ­£ç¢ºå¼•å…¥ ES6 æ¨¡çµ„');
                } else {
                    updateTest(test6, 'fail', 'index.html é…ç½®ç•°å¸¸');
                }
            } catch (e) {
                updateTest(test6, 'fail', `éŒ¯èª¤: ${e.message}`);
            }

            // é¡¯ç¤ºç¸½çµ
            showSummary();
        }

        function showSummary() {
            const container = document.getElementById('testResults');
            const summaryDiv = document.createElement('div');
            const total = passCount + failCount;
            const success = failCount === 0;

            summaryDiv.className = `summary ${success ? 'success' : 'failure'}`;
            summaryDiv.innerHTML = `
                <div>æ¸¬è©¦å®Œæˆï¼</div>
                <div style="margin-top: 10px;">
                    é€šé: ${passCount}/${total} | å¤±æ•—: ${failCount}/${total}
                </div>
                ${success ? '<div style="margin-top: 10px;">ğŸ‰ æ‰€æœ‰ç¨‹å¼ç¢¼æª¢æŸ¥é€šéï¼</div>' : '<div style="margin-top: 10px;">âš ï¸ éƒ¨åˆ†æª¢æŸ¥å¤±æ•—ï¼Œè«‹æŸ¥çœ‹è©³ç´°è³‡è¨Š</div>'}
            `;
            container.insertBefore(summaryDiv, container.firstChild);
        }

        function clearStorage() {
            sessionStorage.clear();
            localStorage.clear();
            alert('Storage å·²æ¸…é™¤ï¼');
        }

        function viewStorage() {
            const storageView = document.getElementById('storageView');
            const sessionContent = document.getElementById('sessionStorageContent');
            const localContent = document.getElementById('localStorageContent');

            const session = {};
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                session[key] = sessionStorage.getItem(key);
            }

            const local = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                local[key] = localStorage.getItem(key);
            }

            sessionContent.textContent = JSON.stringify(session, null, 2);
            localContent.textContent = JSON.stringify(local, null, 2);
            storageView.style.display = 'block';
        }

        document.getElementById('btnRunTests').addEventListener('click', runTests);
        document.getElementById('btnClearStorage').addEventListener('click', clearStorage);
        document.getElementById('btnViewStorage').addEventListener('click', viewStorage);

        // è‡ªå‹•åŸ·è¡Œæ¸¬è©¦
        window.addEventListener('load', () => {
            setTimeout(runTests, 500);
        });
    </script>
</body>

</html>